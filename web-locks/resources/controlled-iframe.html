<!DOCTYPE html>
<meta charset=utf-8>
<title>iframe used in clientId test</title>
<script>

// Wait for event before starting test.
self.onmessage = async _ => {
  try {
    navigator.locks.request('lock-name', async lock => {
      // Use the controlling service worker to determine
      // this client's id.
      const response = await fetch('/clientId');
      const data = await response.json();

      // Query the lock manager for state.
      const lock_state = await navigator.locks.query();
      const held_lock = lock_state.held.filter(l => l.name === lock.name)[0];

      // Send everything back to the parent window.
      window.parent.postMessage({
        sw_clientId: data.clientId,
        lock_clientId: held_lock.clientId
      }, '*');
    });
  } catch (ex) {
    // In case of test failure, don't leave parent window hanging.
    window.parent.postMessage({error: ex.name, message: ex.message}, '*');
  }
};

</script>
